<!DOCTYPE html>
<html lang="en" dir="ltr" style="--primary-rgb: 28, 103, 147">
  <head>
    {% load static %}
    <!-- META DATA -->
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    {% load custom_filters %}

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="description"
      content="Sash â€“ Bootstrap 5  Admin & Dashboard Template"
    />
    <meta name="author" content="Spruko Technologies Private Limited" />
    <meta
      name="keywords"
      content="admin,admin dashboard,admin panel,admin template,bootstrap,clean,dashboard,flat,jquery,modern,responsive,premium admin templates,responsive admin,ui,ui kit."
    />

    <!-- FAVICON -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{% static 'assets/images/brand/favicon.ico' %}"
    />

    <!-- TITLE -->
    <title>Global Monarch</title>

    <!-- BOOTSTRAP CSS -->
    <link
      id="style"
      href="{% static 'assets/plugins/bootstrap/css/bootstrap.min.css' %}"
      rel="stylesheet"
    />

    <!-- STYLE CSS -->
    <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" />

    <!-- Plugins CSS -->
    <link href="{% static 'assets/css/plugins.css' %}" rel="stylesheet" />

    <!--- FONT-ICONS CSS -->
    <link href="{% static 'assets/css/icons.css' %}" rel="stylesheet" />

    <!-- INTERNAL Switcher css -->
    <link
      href="{% static 'assets/switcher/css/switcher.css' %}"
      rel="stylesheet"
    />
    <link href="{% static 'assets/switcher/demo.css' %}" rel="stylesheet" />
  </head>

  <body class="app sidebar-mini ltr light-mode">
    <!-- GLOBAL-LOADER -->
    <div id="global-loader">
      <img
        src="{% static 'assets/images/loader.gif' %}"
        class="loader-img"
        alt="Loader"
      />
    </div>
    <!-- /GLOBAL-LOADER -->

    <!-- PAGE -->
    <div class="page">
      <div class="page-main">
        <!-- app-Header -->
        <div class="app-header header sticky">
          <div class="container-fluid main-container">
            <div class="d-flex">
              <a
                aria-label="Hide Sidebar"
                class="app-sidebar__toggle"
                data-bs-toggle="sidebar"
                href="{% static 'javascript:void(0)' %}"
              ></a>
              <!-- sidebar-toggle-->
              <a class="logo-horizontal" href="{% static 'index.html' %}">
                <img
                  src="{% static 'assets/images/brand/logo-white.png' %}"
                  class="header-brand-img desktop-logo"
                  alt="logo"
                />
                <img
                  src="{% static 'assets/images/brand/logo-dark.png' %}"
                  class="header-brand-img light-logo1"
                  alt="logo"
                />
              </a>

              <div class="d-flex order-lg-2 ms-auto header-right-icons">
                <!-- SEARCH -->
                <button
                  class="navbar-toggler navresponsive-toggler d-lg-none ms-auto"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#navbarSupportedContent-4"
                  aria-controls="navbarSupportedContent-4"
                  aria-expanded="false"
                  aria-label="Toggle navigation"
                >
                  <span class="navbar-toggler-icon fe fe-more-vertical"></span>
                </button>
                <div class="navbar navbar-collapse responsive-navbar p-0">
                  <div
                    class="collapse navbar-collapse"
                    id="navbarSupportedContent-4"
                  >
                    <div class="d-flex order-lg-2">
                      <a
                        href="{% static 'javascript:void(0)' %}"
                        class="nav-link icon"
                        data-bs-toggle="dropdown"
                        data-target=""
                      >
                        <i class="fa fa-sort-down"></i>
                      </a>
                      <div class="dropdown d-flex notifications">
                        <a
                          class="nav-link icon"
                          data-bs-toggle="dropdown"
                          aria-expanded="false"
                          ><i class="fe fe-bell"></i><span class="pulse"></span>
                        </a>
                        <div
                          class="dropdown-menu dropdown-menu-end dropdown-menu-arrow"
                        >
                          <div class="drop-heading border-bottom">
                            <div class="d-flex">
                              <h6 class="mt-1 mb-0 fs-16 fw-semibold text-dark">
                                Notifications
                              </h6>
                            </div>
                          </div>
                          <div class="notifications-menu ps">
                            <a
                              class="dropdown-item d-flex"
                              href="notify-list.html"
                            >
                              <div
                                class="me-3 notifyimg bg-primary brround box-shadow-primary"
                              >
                                <i class="fe fe-mail"></i>
                              </div>
                              <div class="mt-1 wd-80p">
                                <h5 class="notification-label mb-1">
                                  New change made to enquiry of FM96 to Kumas
                                </h5>
                                <span class="notification-subtext"
                                  >1 hour ago</span
                                >
                              </div>
                            </a>
                            <a
                              class="dropdown-item d-flex"
                              href="notify-list.html"
                            >
                              <div
                                class="me-3 notifyimg bg-secondary brround box-shadow-secondary"
                              >
                                <i class="fe fe-mail"></i>
                              </div>
                              <div class="mt-1 wd-80p">
                                <h5 class="notification-label mb-1">
                                  Enquiry deadline coming up
                                </h5>
                                <span class="notification-subtext"
                                  >2 hours ago</span
                                >
                              </div>
                            </a>

                            <div
                              class="ps__rail-x"
                              style="left: 0px; bottom: 0px"
                            >
                              <div
                                class="ps__thumb-x"
                                tabindex="0"
                                style="left: 0px; width: 0px"
                              ></div>
                            </div>
                            <div
                              class="ps__rail-y"
                              style="top: 0px; right: 0px"
                            >
                              <div
                                class="ps__thumb-y"
                                tabindex="0"
                                style="top: 0px; height: 0px"
                              ></div>
                            </div>
                          </div>
                          <div class="dropdown-divider m-0"></div>
                          <a
                            href="notify-list.html"
                            class="dropdown-item text-center p-3 text-muted"
                            >View all Notification</a
                          >
                        </div>
                      </div>
                      <!-- SIDE-MENU -->
                      <div class="dropdown d-flex profile-1">
                        <a
                          href="{% static 'javascript:void(0)' %}"
                          data-bs-toggle="dropdown"
                          class="nav-link leading-none d-flex"
                        >
                          <img
                            src="{% static 'assets/images/users/21.jpg' %}"
                            alt="profile-user"
                            class="avatar profile-user brround cover-image"
                          />
                        </a>
                        <div
                          class="dropdown-menu dropdown-menu-end dropdown-menu-arrow"
                        >
                          <div class="drop-heading">
                            <div class="text-center">
                              <h5 class="text-dark mb-0 fs-14 fw-semibold">
                                {{request.user.username}}
                              </h5>
                            </div>
                          </div>
                          <div class="dropdown-divider m-0"></div>
                          <a class="dropdown-item" href="">
                            <i class="dropdown-icon fe fe-user"></i> Profile
                          </a>
                          <a class="dropdown-item" href="">
                            <i class="dropdown-icon fe fe-alert-circle"></i>
                            Sign out
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /app-Header -->

        <!--APP-SIDEBAR-->
        <div class="sticky">
          <div class="app-sidebar__overlay" data-bs-toggle="sidebar"></div>
          <div class="app-sidebar">
            <div class="side-header">
              <a class="header-brand1" href="">
                <img
                  src="{% static 'assets/images/brand/logo-white.png' %}"
                  class="header-brand-img desktop-logo"
                  alt="logo"
                />
                <img
                  src="{% static 'assets/images/brand/icon-white.png' %}"
                  class="header-brand-img toggle-logo"
                  alt="logo"
                />
                <img
                  src="{% static 'assets/images/brand/icon-dark.png' %}"
                  class="header-brand-img light-logo"
                  alt="logo"
                />
                <img
                  src="{% static 'assets/images/brand/logo-dark.png' %}"
                  class="header-brand-img light-logo1"
                  alt="logo"
                />
              </a>
              <!-- LOGO -->
            </div>
            <div class="main-sidemenu">
              <div class="slide-left disabled" id="slide-left">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="#7b8191"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"
                  />
                </svg>
              </div>
              <ul class="side-menu">
                <li class="slide">
                  <a
                    class="side-menu__item has-link"
                    data-bs-toggle="slide"
                    href="/"
                    ><i class="side-menu__icon fe fe-home"></i
                    ><span class="side-menu__label">Home</span></a
                  >
                </li>
                <li class="slide">
                  <a
                    class="side-menu__item has-link"
                    data-bs-toggle="slide"
                    href="/enquiry_list"
                    ><i class="side-menu__icon fe fe-send"></i
                    ><span class="side-menu__label">Enquiries</span></a
                  >
                </li>
                <li class="slide">
                  <a
                    class="side-menu__item has-link"
                    data-bs-toggle="slide"
                    href="/"
                    ><i class="side-menu__icon fe fe-pie-chart"></i
                    ><span class="side-menu__label">Create new Enquiry</span></a
                  >
                </li>
                <li class="slide">
                  <a
                    class="side-menu__item has-link"
                    data-bs-toggle="slide"
                    href="/supplier_list"
                    ><i class="side-menu__icon fe fe-activity"></i
                    ><span class="side-menu__label"
                      >Supplier Management</span
                    ></a
                  >
                </li>
              </ul>
              <div class="slide-right" id="slide-right">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="#7b8191"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z"
                  />
                </svg>
              </div>
            </div>
          </div>
        </div>
        <!--/APP-SIDEBAR-->

        <!--app-content open-->
        <div class="main-content app-content mt-0">
          <div class="side-app">
            <div class="main-container container-fluid">
              <div class="page-header">
                <h1 class="page-title">Email Management - UNDER PRODUCTION </h1>
                <div>
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="javascript:void(0)">Bootstrap</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                      Tabs
                    </li>
                  </ol>
                </div>
              </div>

              <div class="row">
                <div class="col-xl-12">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Email Enquiries to Suppliers</h3>
                    </div>
                    <div class="card-body">
                      <div class="panel panel-primary">
                        <div class="tab-menu-heading">
                          <div class="tabs-menu">
                            <ul class="nav panel-tabs" role="tablist">
                              {% for email_with_attachments in emails_with_attachments %}
                              <li
                                class="{% if email_with_attachments.email.status|lower == 'sent' %}tab-highlighted{% endif %}"
                              >
                                <a
                                  href="#tab{{ forloop.counter }}"
                                  class="{% if forloop.first %}active{% endif %}"
                                  data-bs-toggle="tab"
                                  aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                                  role="tab"
                                  data-email_id="attach-{{ email_with_attachments.email.id }}"
                                  >
                                  Mail to {{email_with_attachments.email.supplier.name}}
                                  </a>
                              </li>
                              {% endfor %}
                            </ul>
                          </div>
                        </div>
                        <div class="panel-body tabs-menu-body">
                          <div class="tab-content">
                            {% for email_with_attachments in emails_with_attachments %}
                            <div
                              class="tab-pane {% if forloop.first %}active{% endif %}"
                              id="tab{{ forloop.counter }}"
                              role="tabpanel"
                            >
                              <div class="col-xl-12">
                                <div class="card">
                                  <div class="card-header">
                                    <h3 class="card-title">
                                      Forward enquiry to {{ email_with_attachments.email.supplier.name }}
                                    </h3>
                                  </div>
                                  <div class="card-body">
                                    <form>
                                      <div class="form-group">
                                        <div class="row align-items-center">
                                          <label class="col-xl-2 form-label"
                                            >To</label
                                          >
                                          <div class="col-xl-10">
                                            <select class="form-control select2 select2-hidden-accessible"
                                            id="recipients-{{ email_with_attachments.email.id }}"
                                            data-placeholder="Start typing" multiple=""
                                            email-id="{{ email_with_attachments.email.id }}"
                                            data-preselected-emails="{{ email_with_attachments.supplier_emails|join:';' }}">
                                              </select>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="form-group">
                                        <div class="row align-items-center">
                                          <label class="col-xl-2 form-label">CC</label>
                                          <div class="col-xl-10">
                                            <select class="form-control select2 select2-hidden-accessible"
                                            id="cc-{{ email_with_attachments.email.id }}"
                                            data-placeholder="Start typing" multiple=""
                                            email-id="{{ email_with_attachments.email.id }}"
                                            data-preselected-emails="{% for division in email_with_attachments.email.manager.divisions.all %}{% if division.group_mail %}{{ division.group_mail }}{% if not forloop.last %};{% endif %}{% endif %}{% endfor %}">
                                              </select>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="form-group">
                                        <div class="row align-items-center">
                                          <label class="col-xl-2 form-label"
                                            >Subject</label
                                          >
                                          <div class="col-xl-10">
                                            <input
                                              type="text"
                                              id="subject-{{ email_with_attachments.email.id }}"
                                              class="form-control"
                                              value="Enquiry ID:{{ enquiry.id }} - {{ request_obj.product.name }}"
                                            />
                                          </div>
                                        </div>
                                      </div>
                                      <div class="form-group">
                                        <div class="row">
                                          <label class="col-xl-2 form-label"
                                            >Message</label
                                          >
                                          <div class="col-xl-10">
                                            <textarea
                                              rows="15"
                                              id="message-{{ email_with_attachments.email.id }}"
                                              class="form-control"
                                            >
Dear {% if email_with_attachments.email.supplier.contacts.first %}{{ email_with_attachments.email.supplier.contacts.first.name }}{% else %}Valued Supplier{% endif %},

I hope this message finds you well. We are reaching out to you regarding our recent enquiry with ID: {{ enquiry.id }}.

Below are the details of the request associated with this enquiry:

Product: {{ request_obj.product.name }}
Sizes: {{ request_obj.size }}
Incoterms: {{ request_obj.incoterms }}
Packaging: {{ request_obj.packaging}}
Payment Terms: 
{% if request_obj.target_price and request_obj.target_price|stringformat:"s" %}
Target Price: {{ request_obj.target_price }}
{% endif %}
Details: 
{% if request_obj.specs|startswith:"//attach" %}See attached.{% else %}{{ request_obj.specs|escape }}{% endif %}
Quantity: {{ request_obj.quantity }} {{ request_obj.quantity_unit }}
Delivery Schedule:
{% for schedule in request_obj.delivery_schedule %}
  Month: {{ schedule.date|month_name }}, Quantity: {{ schedule.quantity }} {{ request_obj.quantity_unit }}, Sizes: {{ schedule.notes }}
{% endfor %}

Please review the information provided and get back to us with your offer at your earliest convenience.

Thank you,
                                                                                        </textarea
                                            >
                                          </div>
                                        </div>
                                      </div>
                                      <div class="row align-items-center">
                                        <label class="col-xl-2 form-label"
                                          >Files</label
                                        >
                                        <div
                                          class="col-xl-10"
                                          id="file-list-{{ email_with_attachments.email.id }}"
                                        >
                                          <!-- Display existing attachments with a remove button -->
                                          {% for attachment in email_with_attachments.attachments %}
                                          <p>
                                            {{ attachment.file.name }}
                                            <button
                                              type="button"
                                              class="btn btn-danger btn-sm remove-attachment"
                                              data-attachment_id="{{ attachment.id }}"
                                              data-email_id="{{ email_with_attachments.email.id }}"
                                            >
                                              Remove
                                            </button>
                                          </p>
                                          {% endfor %}
                                        </div>
                                      </div>
                                    </form>
                                  </div>
                                  <div class="card-footer d-sm-flex">
                                    <div class="mt-2 mb-2">
                                      <a
                                        href="javascript:void(0)"
                                        class="btn btn-icon btn-white btn-svg attach-button"
                                        data-bs-toggle="tooltip"
                                        title="Attach"
                                        data-email_id="attach-{{ email_with_attachments.email.id }}"
                                      >
                                        <span class="ri-attachment-2"></span>
                                      </a>
                                    </div>
                                    <div class="btn-list ms-auto my-auto">
                                      <button
                                        class="btn btn-primary my-1"
                                        type="button"
                                        disabled=""
                                        style="display: none"
                                        id="loading"
                                      >
                                        <span
                                          class="spinner-border spinner-border-sm"
                                          role="status"
                                          aria-hidden="true"
                                        ></span>
                                        Loading...
                                      </button>
                                      <button
                                        class="btn btn-primary btn-space mb-0 send-email-button"
                                        data-email_id="{{ email_with_attachments.email.id }}"
                                      >
                                        Send message
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <input
                                type="file"
                                id="attachment-input-{{ email_with_attachments.email.id }}"
                                style="display: none"
                                data-email_id="attach-{{ email_with_attachments.email.id }}"
                                multiple
                              />
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              </div>
          </div>
        </div>
        <!--/app-content open-->
      </div>
      <div
        class="modal fade"
        id="attachToAllModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="attachToAllModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachToAllModalLabel">
                Attach to All
              </h5>
              <button
                type="button"
                class="close"
                data-bs-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Do you want to attach the selected files to all draft emails?
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
                id="denyAttachToAll"
              >
                No
              </button>
              <button
                type="button"
                class="btn btn-primary"
                id="confirmAttachToAll"
              >
                Yes
              </button>
            </div>
          </div>
        </div>
      </div>
    


      <!-- FOOTER -->
      <footer class="footer">
        <div class="container">
          <div class="row align-items-center flex-row-reverse">
            <div class="col-md-12 col-sm-12 text-center">
              Copyright Â© <span id="year"></span> Global Monarch F.Z.C. Designed
              with <span class="fa fa-heart text-danger"></span> by
              <a href="javascript:void(0)"> GM-EU</a> All rights reserved.
            </div>
          </div>
        </div>
      </footer>
      <!-- FOOTER CLOSED -->
    </div>

    <!-- BACK-TO-TOP -->
    <a href=" {% static '#top' %} " id="back-to-top"
      ><i class="fa fa-angle-up"></i
    ></a>

    <!-- JQUERY JS -->
    <script src=" {% static '/assets/js/jquery.min.js' %} "></script>

    <!-- Toastr CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
      rel="stylesheet"
    />

    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- BOOTSTRAP JS -->
    <script src=" {% static '/assets/plugins/bootstrap/js/popper.min.js' %} "></script>
    <script src=" {% static '/assets/plugins/bootstrap/js/bootstrap.min.js' %} "></script>

    <!-- TypeHead js -->
    <script src=" {% static '/assets/plugins/bootstrap5-typehead/autocomplete.js' %} "></script>
    <script src=" {% static '/assets/js/typehead.js' %} "></script>

    <!-- SELECT2 JS -->
    <script src=" {% static '/assets/plugins/select2/select2.full.min.js' %} "></script>
    <script src=" {% static '/assets/js/select2.js' %} "></script>

    <!-- Perfect SCROLLBAR JS-->
    <script src=" {% static '/assets/plugins/p-scroll/perfect-scrollbar.js' %} "></script>
    <script src=" {% static '/assets/plugins/p-scroll/pscroll.js' %} "></script>
    <script src=" {% static '/assets/plugins/p-scroll/pscroll-1.js' %} "></script>

    <!-- SIDE-MENU JS -->
    <script src=" {% static '/assets/plugins/sidemenu/sidemenu.js' %} "></script>

        <!-- Toastr CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- SIDEBAR JS -->
    <script src=" {% static '/assets/plugins/sidebar/sidebar.js' %} "></script>

    <!-- Color Theme js -->
    <script src=" {% static '/assets/js/themeColors.js' %} "></script>

    <!-- Sticky js -->
    <script src=" {% static '/assets/js/sticky.js' %} "></script>

    <!-- CUSTOM JS -->
    <script src=" {% static '/assets/js/custom.js' %} "></script>

    <!-- Custom-switcher -->
    <script src=" {% static '/assets/js/custom-swicher.js' %} "></script>

    <!-- Switcher js -->
    <script src=" {% static '/assets/switcher/js/switcher.js' %} "></script>
<!--
    <script>
      $(document).ready(function () {
        $('input[type="file"]').on("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const emailId = $(this).data("email_id");
            const formData = new FormData();
            formData.append("file", file);
            formData.append("email_id", emailId);

            $.ajax({
              url: '{% url "upload_attachment" %}',
              type: "POST",
              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
              },
              data: formData,
              processData: false,
              contentType: false,
              success: function (data) {
                if (data.success) {
                  alert("File uploaded successfully");
                } else {
                  console.log(data);
                  alert("File upload failed");
                }
              },
              error: function (error) {
                console.error("Error:", error);
                alert("An error occurred while uploading the file");
              },
            });
          }
        });
      });
    </script>
-->
    <script>
      //handle attachment
      $(document).ready(function () {
    let globalEmailId;
    let attachToAll = false;
      
// Initialize Select2 with specified settings and pre-selected options
function initializeSelect2WithTags($elements) {
        $elements.each(function() { // Iterate over each element individually
            var $element = $(this); // Current Select2 element being initialized
            var preselectedEmails = $element.data('preselected-emails');
            
            if (preselectedEmails) {
                preselectedEmails = preselectedEmails.split(';').map(email => email.trim());
            } else {
                preselectedEmails = [];
            }

            // Add pre-selected options
            if (preselectedEmails.length) {
                preselectedEmails.forEach(function(email) {
                    var exists = $element.find('option[value="' + email + '"]').length > 0;
                    if (!exists) {
                        var newOption = new Option(email, email, true, true);
                        $element.append(newOption).trigger('change');
                    }
                });
            }

            $element.select2({
                width: '100%',
                tags: true, // Allows new options to be added
                minimumInputLength: 1, // Only start searching when at least one character is typed
                placeholder: "Select suppliers", // Placeholder text
                createTag: function(params) {
                    var term = $.trim(params.term);
                    if (term === '') {
                        return null;
                    }
                    var normalizedTerm = term.replace(/\s+/g, ' ').toLowerCase();
                    // Check for existing options within the current Select2 element
                    var exists = $element.find('option').filter(function() {
                        return $(this).text().toLowerCase() === normalizedTerm;
                    }).length > 0;
                    if (exists) {
                        return null;
                    }
                    return {
                        id: term,
                        text: term,
                        newTag: true
                    };
                }
            }).on('select2:select', function(e) {
                if (e.params.data.newTag) {
                    console.log("New option added:", e.params.data.text);
                    // Additional logic for new tags can be implemented here
                }
            });
        });
    }

    var $selectElements = $('.select2'); // Select the elements you want to initialize with Select2
    console.log($selectElements)
    initializeSelect2WithTags($selectElements);


        
    // Only bind to the attach buttons
    $(".attach-button").on("click", function (event) {
        event.preventDefault(); // Prevent the default action
        event.stopPropagation(); // Prevent the click from bubbling up to the tabs
        globalEmailId = $(this).data("email_id").replace("attach-", "");
        $("#attachToAllModal").modal("show");
    });

    $("#confirmAttachToAll").on("click", function () {
        attachToAll = true;
        $("#attachToAllModal").modal("hide");
        $(`#attachment-input-${globalEmailId}`)
            .data("email_id", `attach-${globalEmailId}`)
            .click();
    });

    $("#denyAttachToAll").on("click", function () {
        attachToAll = false;
        $("#attachToAllModal").modal("hide");
        $(`#attachment-input-${globalEmailId}`)
            .data("email_id", `attach-${globalEmailId}`)
            .click();
    });

    $('input[type="file"]').on("change", function (event) {
        const files = event.target.files;
        if (files.length > 0) {
            const emailIds = attachToAll
                ? getAllEmailIds()
                : [$(this).data("email_id").replace("attach-", "")];
            const formData = new FormData();

            for (let i = 0; i < files.length; i++) {
                formData.append("files[]", files[i]);
            }

            emailIds.forEach((emailId) => {
                formData.append("email_id", emailId);
            });

            $.ajax({
    url: '{% url "upload_attachment" %}',
    type: "POST",
    headers: {
        "X-CSRFToken": "{{ csrf_token }}",
    },
    data: formData,
    processData: false,
    contentType: false,
    success: function (data) {
        if (data.success) {
            toastr.success("Files uploaded successfully");
            // Get the attachments dictionary from the response
            const attachments = data.attachments;

            emailIds.forEach((emailId) => {
                // Display file names and attach icon for each email
                const fileListDiv = $(`#file-list-${emailId}`);
                fileListDiv.empty(); // Clear the current file list

                // Get the attachment IDs for the current email
                const attachmentIds = attachments[emailId];

                for (let i = 0; i < files.length; i++) {
                    const fileName = files[i].name;
                    const attachmentId = attachmentIds[i];

                    // Create the paragraph element with the file name
                    const fileNameParagraph = $("<p>").text(fileName);

                    // Create the remove button
                    const removeButton = $("<button>")
                        .attr("type", "button")
                        .addClass("btn btn-danger btn-sm remove-attachment")
                        .attr("data-attachment_id", attachmentId)
                        .attr("data-email_id", emailId)
                        .text("Remove");

                    // Append the remove button to the paragraph
                    fileNameParagraph.append(removeButton);

                    // Append the paragraph to the file list div
                    fileListDiv.append(fileNameParagraph);
                }
            });
        } else {
          toastr.error("An error occurred: " + data.error);
        }
    },
    error: function (error) {
        console.error("Error:", error);
        toastr.error("An error occurred while uploading the files");
    },
});
        }
        attachToAll = false; // Reset the flag
    });

    // Handle remove attachment button click
    $(document).on("click", ".remove-attachment", function (event) {
        event.preventDefault();
        const attachmentId = $(this).data("attachment_id");
        const emailId = $(this).data("email_id");

        $.ajax({
            url: '{% url "remove_attachment" %}',
            type: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
            data: {
                attachment_id: attachmentId,
            },
            success: function (data) {
                
                  toastr.success("Attachment removed successfully");
                    // Remove the attachment element from the DOM
                    $(`#file-list-${emailId}`)
                        .find(`button[data-attachment_id="${attachmentId}"]`)
                        .parent()
                        .remove();
                
            },
            error: function (error) {
                console.error("Error:", error);
                toastr.error("An error occurred while removing the attachment");
            },
        });
    });

    function getAllEmailIds() {
        const emailIds = [];
        $(".attach-button").each(function () {
            emailIds.push($(this).data("email_id").replace("attach-", ""));
        });
        return emailIds;
    }
});
    </script>

    
<script>
  $(document).ready(function () {
    $(".send-email-button").on("click", function (event) {
      event.preventDefault();

      let emailId = $(this).data("email_id");
      let subject = $(`#subject-${emailId}`).val();
      let message = $(`#message-${emailId}`).val();
      let recipients = $(`#recipients-${emailId}`).val();
      let cc = $(`#cc-${emailId}`).val();
      console.log(emailId);
      console.log(subject);
      console.log(message);
      console.log(recipients);
      console.log(cc);

      // Get the buttons
      let sendButton = $(this);
      let loadingButton = $("#loading");

      // Hide the send button and show the loading button
      sendButton.hide();
      loadingButton.show();
      
      $.ajax({
        url: "{% url 'send_email_ajax' %}",
        type: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        data: {
          email_id: emailId,
          subject: subject,
          message: message,
          recipients: recipients,
          cc: cc,
        },
        success: function (response) {
          if (response.message) {
            toastr.success("Email sent successfully!", "Success");

            // Highlight the tab where the message was sent
            let currentTab = $(
              `.nav.panel-tabs a[data-email_id="attach-${emailId}"]`
            );
            currentTab.closest("li").addClass("tab-highlighted");

            // Get the next tab
            let nextTab = currentTab.closest("li").next().find("a");

            // If there is a next tab, activate it
            if (nextTab.length) {
              nextTab.tab("show");
            } else {
              var enquiryUrl = "{% url 'enquiry' enquiry.id %}";
              window.location.href = enquiryUrl;
            }
          } else {
            toastr.error("Error: " + response.error, "Error");
          }
        },
        error: function (xhr, status, error) {
          console.error("Error:", error);
          toastr.error(
            "An error occurred while sending the email.",
            "Error"
          );
        },
        complete: function () {
          // Hide the loading button and show the send button
          loadingButton.hide();
          sendButton.show();
        },
      });
    });
  });
</script>
    
    <style>
      .tab-highlighted {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
    </style>

   
  </body>
</html>
